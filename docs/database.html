<!DOCTYPE html>

<html>
<head>
  <title>database.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>database.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* This is the backend implementation. The backend can be anything really,
 * if the databse changes, only this file changes. For now it's MongoDB.
 * Backend is a class with methods. It intializes the database on construction.
 * The object can then be passed around and it methods can be called.
 */</span>

<span class="hljs-keyword">var</span>	MongoClient = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>).MongoClient;
<span class="hljs-keyword">var</span> ObjectID = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>).ObjectID;
<span class="hljs-keyword">var</span> when = <span class="hljs-built_in">require</span>(<span class="hljs-string">'when'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Constructor. Connects to database on instantiation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( mongoDbUrl )</span> {</span>
	self = <span class="hljs-keyword">this</span>; <span class="hljs-comment">// VERY IMPORTANT</span>
	self.mongoDbUrl = mongoDbUrl;
	self.db = <span class="hljs-literal">null</span>;
	self.partsMetaColl = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Hold collections in object as well</span>
	self.partsStdThreeMeshColl = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO: More collections, split part metadata and json obj for speed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}
Database.prototype.init = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(  )</span> {</span>
	<span class="hljs-keyword">var</span> d = when.defer(); <span class="hljs-comment">// Set up promise</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cB</span> <span class="hljs-params">( err, db )</span> {</span>
		<span class="hljs-keyword">if</span> ( err || db == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// If error or datbase object empty</span>
			d.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Database connect error"</span>));
		} <span class="hljs-keyword">else</span> {
			self.db = db; <span class="hljs-comment">// self.db, not this.db!!!</span>
			self.partsMetaColl = db.collection(<span class="hljs-string">"partsMeta"</span>);
			self.partsStdThreeMeshColl = db.collection(<span class="hljs-string">"partsStdThreeMesh"</span>);
			d.resolve( db ); <span class="hljs-comment">// Return db???</span>
		}
	}
	MongoClient.connect( self.mongoDbUrl , cB );
	<span class="hljs-keyword">return</span> d.promise;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Inserts the JSON object into the parts collection. id is optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype._insert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( collection, jsonObject, id )</span> {</span>
	<span class="hljs-keyword">var</span> d = when.defer();
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkCb</span> <span class="hljs-params">( err, result )</span> {</span>
		<span class="hljs-keyword">if</span> (err) d.reject( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Error when inserting part"</span>) );
		<span class="hljs-keyword">else</span> d.resolve( result );
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If id is given, set the object’s id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> ( id ) jsonObject._id = id;
	collection.insert( jsonObject, checkCb );
	<span class="hljs-keyword">return</span> d.promise;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Insert part metadata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype.insertPartMeta = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( jsonObject )</span> {</span>
	<span class="hljs-keyword">return</span> self._insert ( self.partsMetaColl, jsonObject ) <span class="hljs-comment">// Returns promise</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Insert standard Three.js JSON mesh. Must give an id (that matches the part metadata’s)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype.insertPartStdThreeMesh = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( id, jsonThreeMesh )</span> {</span>
	<span class="hljs-keyword">return</span> self._insert ( self.partsStdThreeMeshColl, jsonThreeMesh, id ) <span class="hljs-comment">// Returns promise</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Find one part by its ID. The underscore indicates that it’s a private method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype._findOneById = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( collection, id )</span> {</span>
	<span class="hljs-keyword">var</span> d = when.defer();
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cB</span> <span class="hljs-params">(err, doc)</span> {</span>
		<span class="hljs-keyword">if</span> (err || !doc) d.reject( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Not found or error"</span>) );
		<span class="hljs-keyword">else</span> d.resolve( doc );
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>If id is a string and not an ObjectID… convert it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span>(id) === <span class="hljs-string">"string"</span> ) {
		id = ObjectID(id);
	}
	collection.findOne( { _id: id }, cB );
	<span class="hljs-keyword">return</span> d.promise;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Find part metadata by ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype.findPartMeta = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( id )</span> {</span>
	<span class="hljs-keyword">return</span> self._findOneById( self.partsMetaColl, id ) <span class="hljs-comment">// Returns promise</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Find standard Three.js JSON mesh</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype.findStdThreeMesh = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( id )</span> {</span>
	<span class="hljs-keyword">return</span> self._findOneById( self.partsStdThreeMeshColl, id ) <span class="hljs-comment">// Returns promise</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Preliminary function to search multiple parts. Needs filters. And spec.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype.findParts = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( n )</span> {</span>
	<span class="hljs-keyword">var</span> d = when.defer();</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>This callback function is repeated several times. If it doesn’t change much,
make it separate (DRY).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cB</span> <span class="hljs-params">( err, docs )</span> {</span>
		<span class="hljs-keyword">if</span> (err) d.reject( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"callback error"</span>) );
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!docs) d.reject( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"doc is empty"</span>) );
		<span class="hljs-keyword">else</span> d.resolve( docs );
	}
	self.partsMetaColl.find( {}, { limit: n } ).toArray( cB );
	<span class="hljs-keyword">return</span> d.promise;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Close the database to avoid many connections building up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Database.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
	self.db.close();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Export the class. Needs to be instantiated with <code>new</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.Database = Database;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
